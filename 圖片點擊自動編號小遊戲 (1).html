<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç®¡æé»æ“Šç·¨è™Ÿ App (å¯ç¸®æ”¾ç‰ˆ)</title>
  <style>
    body { font-family: sans-serif; background: #333; margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; }
    
    .controls { 
      background: white; padding: 10px; width: 100%; box-sizing: border-box;
      position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.5);
      display: flex; flex-wrap: wrap; gap: 8px; align-items: center; justify-content: center;
    }
    
    /* æ²å‹•å®¹å™¨ï¼šè®“åœ–ç‰‡è®Šå¤§æ™‚å¯ä»¥å·¦å³ä¸Šä¸‹æ»‘å‹• */
    #scroll-wrapper {
      width: 100%;
      height: calc(100vh - 120px);
      overflow: auto;
      background: #444;
      display: block;
    }

    #container { 
      position: relative; 
      display: inline-block; /* è®“å®¹å™¨éš¨åœ–ç‰‡å¤§å°æ’é–‹ */
      line-height: 0;
      margin: 0 auto;
    }
    
    #uploadedImage { 
      width: 100%; /* åˆå§‹å¯¬åº¦ */
      height: auto; 
      display: block; 
    }

    .marker { 
      position: absolute; color: #ff0000; font-weight: bold; pointer-events: none; 
      transform: translate(-50%, -50%); 
      text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff; 
      line-height: 1; z-index: 10;
    }

    button { padding: 8px 12px; border: none; border-radius: 5px; background: #007bff; color: white; font-weight: bold; cursor: pointer; }
    .btn-danger { background: #dc3545; }
    .btn-success { background: #28a745; }
    
    .slider-group {
      width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px; padding: 5px 0; font-size: 14px;
    }
    input[type="range"] { width: 120px; }
    #canvasHelper { display: none; }
  </style>
</head>
<body>

  <div class="controls">
    <input type="file" id="imageUpload" accept="image/*" style="width: 100%; margin-bottom: 5px;" />
    <span id="counter">ç·¨è™Ÿï¼š0</span>
    <button onclick="undoLast()">ä¸Šä¸€æ­¥</button>
    <button class="btn-danger" onclick="resetMarkers()">é‡ç½®</button>
    <button class="btn-success" onclick="exportImage()">å„²å­˜åœ–ç‰‡</button>
    
    <div class="slider-group">
      ğŸ” åœ–ç‰‡å¤§å° <input type="range" id="zoomRange" min="50" max="400" value="100" />
      å­—é«” <input type="range" id="fontSize" min="10" max="100" value="24" />
    </div>
  </div>

  <div id="scroll-wrapper">
    <div id="container">
      <img id="uploadedImage" />
    </div>
  </div>

  <canvas id="canvasHelper"></canvas>

  <script>
    const imageUpload = document.getElementById('imageUpload');
    const uploadedImage = document.getElementById('uploadedImage');
    const container = document.getElementById('container');
    const zoomRange = document.getElementById('zoomRange');
    const fontSizeInput = document.getElementById('fontSize');
    const counterText = document.getElementById('counter');

    let currentNumber = 0;
    let markersStack = [];

    // 1. åœ–ç‰‡ç¸®æ”¾æ§åˆ¶
    zoomRange.addEventListener('input', function() {
      const zoomValue = this.value;
      // èª¿æ•´åœ–ç‰‡å¯¬åº¦ï¼Œä¸¦è®“å®¹å™¨è·Ÿè‘—è®Šå¤§
      uploadedImage.style.width = zoomValue + '%';
      container.style.width = zoomValue + '%';
    });

    // 2. åœ–ç‰‡ä¸Šå‚³
    imageUpload.addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (event) {
        uploadedImage.src = event.target.result;
        resetMarkers();
        zoomRange.value = 100; // é‡ç½®ç¸®æ”¾å€ç‡
        uploadedImage.style.width = '100%';
        container.style.width = '100%';
      };
      reader.readAsDataURL(file);
    });

    // 3. é»æ“Šç·¨è™Ÿ
    container.addEventListener('click', function(e) {
      if (!uploadedImage.src) return;
      
      currentNumber++;
      const rect = container.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      // è¨ˆç®—ç™¾åˆ†æ¯”åº§æ¨™ï¼ˆä¸è«–ç¸®æ”¾å¤šå°‘ï¼Œç›¸å°ä½ç½®ä¸è®Šï¼‰
      const xPct = (x / rect.width) * 100;
      const yPct = (y / rect.height) * 100;

      const marker = document.createElement('div');
      marker.className = 'marker';
      marker.textContent = currentNumber;
      marker.style.left = xPct + '%';
      marker.style.top = yPct + '%';
      marker.style.fontSize = fontSizeInput.value + 'px';
      
      marker.dataset.rawX = xPct;
      marker.dataset.rawY = yPct;

      container.appendChild(marker);
      markersStack.push(marker);
      counterText.textContent = 'ç·¨è™Ÿï¼š' + currentNumber;
    });

    // 4. åŠŸèƒ½å‡½æ•¸
    function resetMarkers() {
      currentNumber = 0;
      counterText.textContent = 'ç·¨è™Ÿï¼š0';
      document.querySelectorAll('.marker').forEach(m => m.remove());
      markersStack = [];
    }

    function undoLast() {
      const last = markersStack.pop();
      if (!last) return;
      last.remove();
      currentNumber--;
      counterText.textContent = 'ç·¨è™Ÿï¼š' + currentNumber;
    }

    // æ›´æ–°å­—é«”å¤§å°
    fontSizeInput.addEventListener('input', function() {
      const markers = document.querySelectorAll('.marker');
      markers.forEach(m => m.style.fontSize = this.value + 'px');
    });

    function exportImage() {
      if (!uploadedImage.src) return;
      const canvas = document.getElementById('canvasHelper');
      const ctx = canvas.getContext('2d');
      const img = uploadedImage;

      canvas.width = img.naturalWidth;
      canvas.height = img.naturalHeight;
      ctx.drawImage(img, 0, 0);

      const fSize = (fontSizeInput.value / uploadedImage.offsetWidth) * img.naturalWidth;
      ctx.fillStyle = "red";
      ctx.strokeStyle = "white";
      ctx.lineWidth = Math.max(2, fSize/8);
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.font = `bold ${fSize}px Arial`;

      markersStack.forEach((marker, index) => {
        const x = (parseFloat(marker.dataset.rawX) / 100) * canvas.width;
        const y = (parseFloat(marker.dataset.rawY) / 100) * canvas.height;
        ctx.strokeText(index + 1, x, y);
        ctx.fillText(index + 1, x, y);
      });

      const link = document.createElement('a');
      link.download = 'PipeCount_Result.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    }
  </script>
</body>
</html>
